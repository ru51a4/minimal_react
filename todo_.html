<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

    <script src="dombuilder.js"></script>
</head>
<style>



    body{
        background: url("https://miro.medium.com/max/2400/1*HSisLuifMO6KbLfPOKtLow.jpeg");
        background-size: cover;
        font-family: 'Roboto', sans-serif;
        font-size: 14px;
    }
    .btn{
        font-family: 'Roboto', sans-serif!important;
        font-size: 14px!important;
        outline: none!important;
    }
    .btn:focus{
        box-shadow: none!important;

    }
    .form-control{
        font-family: 'Roboto', sans-serif!important;
        font-size: 14px!important;
    }

    ul {
        padding: 0px !important;
    }

    li {
        padding: 10px;
        margin: 5px;
        background: gray;
        color: white;
        display: flex;
        justify-content: space-between;
    }

    .complete {
        background: green;
    }
</style>
<body>
<div class="container d-flex justify-content-center mt-4">
    <div class="card">
        <div class="card-body">
            <div class="main">
                <todo></todo>
            </div>
        </div>
    </div>
</div>
</body>

<script>
    var Render;
    var domBuilder = new BuilderDOM();

    class component {
        name = '';

        constructor(_name) {
            this.name = _name;
        }
    }

    class component_todo extends component {
        state = {
            serf: false,
            current: '',
            todos: [
                {complete: false, title: 'помыть посуду'},
                {complete: false, title: 'приготовить обед'},
                {complete: false, title: 'приготовить ужин'}
            ]
        };

        body() {
            return `
             <div>
                <div r-if="${this.state.serf}">
                получишь по жопе
                </div>
                <button class="btn btn-primary" onclick="runEvent('${this.name}', 'serf')">
                    <span r-if="${this.state.serf}">ладно поняль(</span>
                    <span r-if="${!this.state.serf}">целый день играть в сабей серфер</span>
                </button>
                <div class="d-flex jusitfy-content-center flex-column" r-if="${!this.state.serf}">
                    <div>список дел на сегодня:</div>
                    <ul>
                        ${this.state.todos.reduce((acc, item) => acc +
                `
                        <li class="${(item.complete) ? 'complete' : ''}">
                            <span>${item.title}</span>
                            <button class="btn btn-primary" onclick="runEvent('${this.name}', 'complete', '${item.title}')">
                            <span r-if="${!item.complete}">готово</span>
                            <span r-if="${item.complete}">отмена</span>
                            </button>
                        </li>
                        ` + "\n", '')}
                    </ul>
                    <input class="form-control" type="text" onchange="model('${this.name}', {event: event, key: 'current'})">
                    </input>
                    <button class="mt-2 btn btn-primary" onclick="runEvent('${this.name}', 'add')">добавить</button>
                </div>
            </div>
        `
        };

        add() {
            if (this.state.current.length > 0 && !this.state.todos.find(item => item.title === this.state.current)) {
                this.state.todos.push({title: this.state.current, complete: false});
            }
        }

        serf() {
            this.state.serf = !this.state.serf;
        }

        complete(title) {
            this.state.todos.find(item => item.title === title).complete = !this.state.todos.find(item => item.title === title).complete;
        }
    }


    function runEvent(name, nameEvent, arg) {
        currentComponents.find((item) => {
            item = item.hierarchy.split('.');
            return item[item.length - 1] === name;
        }).component[nameEvent](arg);
        Render.renderDom();
    }

    function runParrentEvent(name, nameEvent) {
        let nameParrent = '';
        currentComponents.forEach((item) => {
            item = item.hierarchy.split('.');
            if (item[item.length - 1] === name) {
                nameParrent = item[item.length - 2];
            }
        });
        runEvent(nameParrent, nameEvent);
    }

    function model(name, {event, key}) {
        const value = event.target.value;
        currentComponents.find((item) => {
            item = item.hierarchy.split('.');
            return item[item.length - 1] === name;
        }).component.state[key] = value;
        Render.renderDom();
    }

    var components = {};
    var currentComponents = [];

    class render {
        currentDom;
        init = true;
        vdom = [];
        prevVdom = [];
        hiddenEls = [];

        constructor() {
            components = [
                {
                    name: 'todo',
                    component: component_todo
                },
            ];
            this.currentDom = document.querySelector('.main').innerHTML.trim().split("\n");
        }

        renderDom() {
            var currentDom = '';
            let counter = 0;

            this.currentDom.forEach((tag) => {
                //deep
                var hierarchyStack = [];

                function deep(tag) {
                    const tagName = this.utils.getTag(tag);
                    if (!this.utils.isComponent(tagName)) {
                        currentDom += tag + "\n";
                    } else {
                        const currentName = `${tagName}-${counter++}`;
                        let component = currentComponents.find(item => item.name === currentName);
                        hierarchyStack.push(currentName);
                        if (!component) {
                            let currentComponent = components.find((item) => item.name === tagName).component;
                            component = new currentComponent(currentName);
                            currentComponents.push({
                                name: currentName,
                                component: component,
                                hierarchy: hierarchyStack.join('.')
                            });
                        } else {
                            component = component.component;
                        }
                        let currentComponentDom = component.body();
                        currentComponentDom.split("\n").forEach((tag) => {
                            deep.bind(this, tag)();
                        });
                        hierarchyStack.pop(currentName);
                    }
                }

                deep.bind(this, tag)();
                //
            });

            //todo dom
            if (!this.init) {
                function getDomEl(virtualDomStack) {
                    let currentDocumentDom = document.querySelector('.main');

                    for (let i = 1; i <= virtualDomStack.length - 1; i++) {
                        let numChild = this.vdom.find(el => el.id == virtualDomStack[i]).numChild;
                        if (currentDocumentDom.children[numChild]) {
                            currentDocumentDom = currentDocumentDom.children[numChild];
                        }
                    }
                    return currentDocumentDom;
                }

                var stackUpdateDom = [];
                this.vdom = domBuilder.build(currentDom);

                function deepReplace(index) {
                    let elVdom = this.vdom[index];
                    let prevElVdom = this.prevVdom[index];
                    if (!elVdom.rIf && !stackUpdateDom.map(item => item.el.id).includes(elVdom.id) && !this.hiddenEls.includes(elVdom.id) && prevElVdom && elVdom && (elVdom.innerTEXT.trim() !== prevElVdom.innerTEXT.trim() || elVdom.tag !== prevElVdom.tag)) {
                        console.log({innerTEXT: elVdom.innerTEXT});
                        stackUpdateDom.push({el: elVdom, event: 'innerTEXT'});
                    }
                    if (!elVdom.visible && !this.hiddenEls.includes(elVdom.id)) {
                        stackUpdateDom.push({el: elVdom, event: 'delete'});
                        this.hiddenEls.push(elVdom.id);
                    }
                    if (elVdom.visible && this.hiddenEls.includes(elVdom.id)) {
                        stackUpdateDom.push({el: elVdom, event: 'create'});
                        this.hiddenEls = this.hiddenEls.filter((item) => item !== elVdom.id);
                    }
                    elVdom.childrens.forEach((childId) => {
                        var domElIndex;
                        this.vdom.forEach((item, elIndex) => {
                            if (item.id === childId) {
                                domElIndex = elIndex;
                            }
                        });
                        deepReplace.bind(this, domElIndex)();
                    })
                }

                deepReplace.bind(this, 1)();


                //todo
                //fix numchild
                this.hiddenEls.forEach((elVdomId) => {
                    const elVdom = this.vdom[elVdomId];
                    const childs = this.vdom[elVdom.parrent[elVdom.parrent.length - 1]].childrens
                    let iStart = 0;
                    for (let i = 0; i <= childs.length - 1; i++) {
                        if (childs[i] === elVdom.id) {
                            iStart = i + 1;
                            break;
                        }
                    }
                    for (let i = iStart; i <= childs.length - 1; i++) {
                        this.vdom[childs[i]].numChild -= 1;
                    }
                });
                console.log({stackUpdateDom})
                stackUpdateDom.forEach((itemUpdate) => {
                    let domEl = getDomEl.bind(this, [...itemUpdate.el.parrent, itemUpdate.el.id])();
                    let html = '';

                    function sumHtml(index, init = false, create = false) {
                        const el = this.vdom.find(el => el.id === index);
                        if(el.tag.includes(`r-if="false"`)){
                            return;
                        }
                        if (!init || create) {
                            html += el.tag + el.innerTEXT;
                        }
                        this.vdom.find(el => el.id === index).childrens.forEach((childId) => {
                            sumHtml.bind(this, childId)();
                        });
                        if (!init || create) {
                            html += el.closedtag;
                        }
                    }

                    switch (itemUpdate.event) {
                        case "delete":
                            domEl.remove();
                            break;
                        case "create":
                            domEl = getDomEl.bind(this, [...itemUpdate.el.parrent])();
                            sumHtml.bind(this, itemUpdate.el.id, true, true)();
                            if (domEl.children[itemUpdate.el.numChild - 1]) {
                                domEl.children[itemUpdate.el.numChild - 1].insertAdjacentHTML('afterend', html);
                            } else if (domEl.children.length === 0) {
                                domEl.innerHTML = html;
                            } else {
                                domEl.children[itemUpdate.el.numChild].insertAdjacentHTML('beforebegin', html);
                            }
                            break;
                        case "innerTEXT":
                            domEl = getDomEl.bind(this, [...itemUpdate.el.parrent])();
                            sumHtml.bind(this, itemUpdate.el.parrent[itemUpdate.el.parrent.length - 1], true)();
                            domEl.innerHTML = html;
                            //console.log({html});
                            break;
                    }
                });
                this.prevVdom = this.vdom;
            } else {
                document.querySelector('.main').innerHTML = currentDom;
                this.init = false;
                this.prevVdom = domBuilder.build(currentDom);
            }
            ////////////
        }

        utils = {
            isComponent(tag) {
                return components.map(item => item.name).includes(tag);
            },
            getTag(str) {
                return str.split("</")[0].replace("<", "").replace(">", "").trim();
            }
        };
    }

    Render = new render();

    function main() {
        Render.renderDom();
        //initfix
        Render.renderDom();

    }

    main();

</script>

