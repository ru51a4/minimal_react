<html>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

    <script src="dombuilder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.8.1/rxjs.umd.min.js"
        integrity="sha512-D9LDs8YUUVa4V9Gl4Zb+xqRAc7RCzooR3+zzebgK2RMu/KU+dh90pbjEEMzPiSyRSGbSp9j1pZnrO4joGa5WEg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<style>
    body {
        background: url("https://studio.uxpincdn.com/studio/wp-content/uploads/2020/12/7-Best-Reasons-To-Use-React.js-Components-In-Your-Project.png.webp");
        font-family: 'Roboto', sans-serif;
        font-size: 14px;
    }

    .btn {
        font-family: 'Roboto', sans-serif !important;
        font-size: 14px !important;
        outline: none !important;
    }

    .btn:focus {
        box-shadow: none !important;

    }

    .form-control {
        font-family: 'Roboto', sans-serif !important;
        font-size: 14px !important;
    }

    ul {
        padding: 0px !important;
    }

    li {
        padding: 10px;
        margin: 5px;
        background: gray;
        color: white;
        display: flex;
        justify-content: space-between;
    }

    .complete {
        background: green;
    }
</style>

<body>
    <div class="container d-flex justify-content-center mt-4">
        <div class="card">
            <div class="card-body">
                <div class="main">
                    <todo></todo>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    const { Subject } = rxjs;

    class store {
        btnEvent = new Subject();
    };
    let _store = new store();

    var Render;
    var domBuilder = new BuilderDOM();

    class component {
        name = '';

        constructor(_name) {
            this.name = _name;
        }
        init = () => {

        }
    }

    class component_todo extends component {
        state = {
            serf: false,
            current: '',
            todos: [
                { complete: false, title: 'помыть посуду' },
                { complete: false, title: 'приготовить обед' },
                { complete: false, title: 'приготовить ужин' }
            ]
        };
        init = () => {
            _store.btnEvent.subscribe((serf) => {
                runEvent(this.name, 'setSerf', serf);
            });
        }
        setSerf = (serf) => {
            this.state.serf = serf;
        }
        body() {
            return `

             <div class="asda">
             <div class="asd">

                 <div r-if="${this.state.serf}">
                получишь по жопе
                </div>
                <btn></btn>
                <div class="d-flex jusitfy-content-center flex-column" r-if="${!this.state.serf}">
                    <div>список дел на сегодня:</div>
                    <ul>
                        ${this.state.todos.reduce((acc, item) => acc +
                `
                        <li class="${(item.complete) ? 'complete' : ''}">
                            <span>${item.title}</span>
                            <button class="btn btn-primary" onclick="runEvent('${this.name}', 'complete', '${item.title}')">
                            <span r-if="${!item.complete}">готово</span>
                            <span r-if="${item.complete}">отмена</span>
                            </button>
                        </li>
                        ` + "\n", '')}
                    </ul>
                    <input class="form-control" type="text" onchange="model('${this.name}', {event: event, key: 'current'})">
                    </input>
                    <button class="mt-2 btn btn-primary" onclick="runEvent('${this.name}', 'add')">добавить</button>
                </div>

            </div>

            </div>
        `
        };

        add() {
            if (this.state.current.length > 0 && !this.state.todos.find(item => item.title === this.state.current)) {
                this.state.todos.push({ title: this.state.current, complete: false });
            }
        }

        serf() {
            this.state.serf = !this.state.serf;
        }

        complete(title) {
            this.state.todos.find(item => item.title === title).complete = !this.state.todos.find(item => item.title === title).complete;
        }
    }

    class component_btn extends component {

        state = {
            serf: false
        }
        init = () => {
            _store.btnEvent.subscribe((serf) => {
                runEvent(this.name, 'setSerf', serf);
            });
        }
        serf = () => {
            _store.btnEvent.next(!this.state.serf);
        }
        setSerf = (serf) => {
            this.state.serf = serf;
        }
        body() {
            return `<button class="btn btn-primary" onclick="runEvent('${this.name}', 'serf')">
                    <span r-if="${this.state.serf}">ладно поняль(</span>
                    <span r-if="${!this.state.serf}">целый день играть в сабвей серфер</span>
            </button>`
        }
    }


    function runEvent(name, nameEvent, arg) {
        currentComponents.find((item) => {
            item = item.hierarchy.split('.');
            return item[item.length - 1] === name;
        }).component[nameEvent](arg);
        Render.renderDom();
    }

    function runParrentEvent(name, nameEvent) {
        let nameParrent = '';
        currentComponents.forEach((item) => {
            item = item.hierarchy.split('.');
            if (item[item.length - 1] === name) {
                nameParrent = item[item.length - 2];
            }
        });
        runEvent(nameParrent, nameEvent);
    }

    function model(name, { event, key }) {
        const value = event.target.value;
        currentComponents.find((item) => {
            item = item.hierarchy.split('.');
            return item[item.length - 1] === name;
        }).component.state[key] = value;
        Render.renderDom();
    }

    var components = {};
    var currentComponents = [];

    class render {
        currentDom;
        init = true;
        vdom = [];
        prevVdom = [];
        hiddenEls = [];

        constructor() {
            components = [
                {
                    name: 'todo',
                    component: component_todo
                },
                {
                    name: 'btn',
                    component: component_btn
                }
            ];
            this.currentDom = document.querySelector('.main').innerHTML.trim().split("\n");
        }

        renderDom() {
            var currentDom = '';
            let counter = 0;

            this.currentDom.forEach((tag) => {
                //deep
                var hierarchyStack = [];

                function deep(tag) {
                    const tagName = this.utils.getTag(tag);
                    if (!this.utils.isComponent(tagName)) {
                        currentDom += tag + "\n";
                    } else {
                        const currentName = `${tagName}-${counter++}`;
                        let component = currentComponents.find(item => item.name === currentName);
                        hierarchyStack.push(currentName);
                        if (!component) {
                            let currentComponent = components.find((item) => item.name === tagName).component;
                            component = new currentComponent(currentName);
                            component.init();
                            currentComponents.push({
                                name: currentName,
                                component: component,
                                hierarchy: hierarchyStack.join('.')
                            });
                        } else {
                            component = component.component;
                        }
                        let currentComponentDom = component.body();
                        currentComponentDom.split("\n").forEach((tag) => {
                            deep.bind(this, tag)();
                        });
                        hierarchyStack.pop(currentName);
                    }
                }

                deep.bind(this, tag)();
                //
            });
            let html = '';
            let htmllvl = 0;
            function sumHtml(index, init = false, create = false, sss = false) {
                if (sss) {
                    htmllvl = 0;
                } else {
                    htmllvl++;
                }
                const el = this.vdom.find(el => el.id === index);
                if (el.tag.includes(`r-if="false"`)) {
                    return;
                }
                if (htmllvl !== 0) {
                    html += el.tag + el.innerTEXT;
                }
                el.childrens.forEach((childId) => {
                    sumHtml.bind(this, childId, true, true)();
                });
                if (htmllvl !== 0) {
                    html += el.closedtag;
                }
            }
            //todo dom
            if (!this.init) {
                function getDomEl(virtualDomStack, ff) {
                    let currentDocumentDom = document.querySelector('.main');

                    for (let i = 1; i <= virtualDomStack.length - 1; i++) {
                        let numChild = this.vdom.find(el => el.id == virtualDomStack[i]).numChild;
                        console.log({ numChild })
                        if (currentDocumentDom.children[numChild]) {

                            currentDocumentDom = currentDocumentDom.children[numChild];
                        }
                    }

                    return currentDocumentDom;
                }
                var stackUpdateDom = [];
                this.vdom = domBuilder.build(currentDom);
                let kek = false;


                function deepReplace(index) {
                    let elVdom = this.vdom[index];
                    let prevElVdom = this.prevVdom[index];

                    if (!elVdom) {
                        stackUpdateDom.push({ prev: prevElVdom, el: elVdom, type: "delete" })
                        return;
                    }

                    let q1 = { ...elVdom, childrens: "" };
                    let q2 = { ...prevElVdom, childrens: "" };
                    if (JSON.stringify(q1) !== JSON.stringify(q2)) {
                        let qq = this.prevVdom.find((el) => el.id == q1.parrent[q1.parrent.length - 1])
                        let qq2 = this.prevVdom.find((el) => el.id == q2.parrent[q2.parrent.length - 1])

                        stackUpdateDom.push({ prev: qq2, el: qq, type: "create" })
                        return;
                    }



                    let c1 = elVdom.childrens.length;
                    let c2 = prevElVdom.childrens.length;
                    let c3 = (c1 > c2) ? c1 : c2;
                    for (let i = 0; i <= c3 - 1; i++) {
                        let cc1 = this.vdom.find((el) => el.id == elVdom.childrens[i]);
                        let cc2 = this.prevVdom.find((el) => el.id == prevElVdom.childrens[i]);
                        if (JSON.stringify(cc1) != JSON.stringify(cc2)) {
                            let q1 = { ...cc1, childrens: "" };
                            let q2 = { ...cc2, childrens: "" };
                            console.log({ q1, q2 })
                            if (JSON.stringify(q1) !== JSON.stringify(q2)) {
                                stackUpdateDom.push({ prev: prevElVdom, el: elVdom, type: "create" })
                                return;
                            } {
                                var domElIndex;
                                this.prevVdom.forEach((item, elIndex) => {
                                    if (cc1.id === item.id) {
                                        domElIndex = elIndex;
                                    }
                                });

                                deepReplace.bind(this, domElIndex)();
                            }
                            return;
                        } else {
                            var domElIndex;
                            this.prevVdom.forEach((item, elIndex) => {
                                if (cc1.id === item.id) {
                                    domElIndex = elIndex;
                                }
                            });

                            deepReplace.bind(this, domElIndex)();

                        }
                    }
                    if (elVdom.innerTEXT.trim() !== prevElVdom.innerTEXT.trim()) {
                        stackUpdateDom.push({ prev: prevElVdom, el: elVdom, type: "text" })
                        return;
                    }

                }

                deepReplace.bind(this, 1)();

                console.log({ stackUpdateDom })
                stackUpdateDom.forEach((itemUpdate) => {
                    let domEl = getDomEl.bind(this, [...itemUpdate.prev.parrent, itemUpdate.prev.id], true)();
                    html = '';
                    console.log({ domEl });

                    switch (itemUpdate.type) {
                        case "delete":
                            domEl.remove();
                            break;
                        case "create":
                            sumHtml.bind(this, itemUpdate.el.id, true, true, true)();
                            console.log({ html })
                            domEl.innerHTML = html;
                            break;
                        case "text":
                            domEl.innerText = itemUpdate.el.innerTEXT;
                            break;
                    }
                });
                this.prevVdom = JSON.parse(JSON.stringify(this.vdom));
            } else {
                this.vdom = domBuilder.build(currentDom);
                sumHtml.bind(this, 1, true, true)();
                document.querySelector('.main').innerHTML = html;
                this.init = false;
                this.prevVdom = domBuilder.build(currentDom);
            }
            ////////////
        }

        utils = {
            isComponent(tag) {
                return components.map(item => item.name).includes(tag);
            },
            getTag(str) {
                return str.split("</")[0].replace("<", "").replace(">", "").trim();
            }
        };
    }

    Render = new render();

    function main() {
        Render.renderDom();

    }

    main();

</script>

</html>